{% extends 'finance/base.html' %}

{% block title %}{% if is_edit %}Editar{% else %}Nova{% endif %} Transação Composta - Finanças{% endblock %}

{% block content %}
    <h1>{% if is_edit %}Editar{% else %}Nova{% endif %} Transação Composta</h1>
    
    {% if messages %}
    <div>
        {% for message in messages %}
        <div>{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if form.non_field_errors %}
    <div style="color: red; margin-bottom: 15px;">
        {% for error in form.non_field_errors %}
        <div>{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}
    
    <form method="post" id="composite-form">
        {% csrf_token %}
        
        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
            <h2>Informações Compartilhadas</h2>
            
            <div style="margin-bottom: 15px;">
                <label for="{{ form.account.id_for_label }}">{{ form.account.label }}</label>
                {{ form.account }}
                {% if form.account.errors %}
                    <div style="color: red;">{{ form.account.errors }}</div>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="{{ form.buy_date.id_for_label }}">{{ form.buy_date.label }}</label>
                {{ form.buy_date }}
                {% if form.buy_date.errors %}
                    <div style="color: red;">{{ form.buy_date.errors }}</div>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="{{ form.pay_date.id_for_label }}">{{ form.pay_date.label }}</label>
                {{ form.pay_date }}
                {% if form.pay_date.errors %}
                    <div style="color: red;">{{ form.pay_date.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h2>Linhas de Transação</h2>
            <button type="button" id="add-line-btn" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">
                + Adicionar Linha
            </button>
            
            <div id="lines-container">
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Transferência</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Categoria / Conta Destino</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Tipo</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Valor</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Descrição</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lines-tbody">
                        <!-- Linhas serão adicionadas aqui via JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background-color: #e7f3ff; border-radius: 5px;">
                <strong>Saldo Líquido: <span id="net-balance">R$ 0,00</span></strong>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                {% if is_edit %}Atualizar{% else %}Criar{% endif %} Transação Composta
            </button>
            {% if is_edit %}
            <a href="{% url 'finance:transactions_list' %}" style="margin-left: 10px; padding: 10px 20px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                Cancelar
            </a>
            {% else %}
            <a href="{% url 'finance:transaction_type_select' %}" style="margin-left: 10px; padding: 10px 20px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                Cancelar
            </a>
            {% endif %}
        </div>
    </form>
    
    <script>
        let lineCounter = 0;
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function calculateNetBalance() {
            let total = 0;
            const lines = document.querySelectorAll('.transaction-line');
            
            lines.forEach(line => {
                const valueInput = line.querySelector('input[name*="_value"]');
                const typeSelect = line.querySelector('select[name*="_transaction_type"]');
                
                if (valueInput && typeSelect && valueInput.value) {
                    const value = parseFloat(valueInput.value) || 0;
                    const type = typeSelect.value;
                    
                    if (type === 'CR') {
                        total += value;
                    } else if (type === 'DB') {
                        total -= value;
                    }
                }
            });
            
            document.getElementById('net-balance').textContent = formatCurrency(total);
        }
        
        function toggleLineFields(lineElement) {
            const transferCheckbox = lineElement.querySelector('input[name*="_is_transfer"]');
            const categorySelect = lineElement.querySelector('.category-select');
            const destinationAccountSelect = lineElement.querySelector('.destination-account-select');
            const transactionTypeSelect = lineElement.querySelector('.transaction-type-select');
            
            if (transferCheckbox) {
                const isTransfer = transferCheckbox.checked;
                
                if (isTransfer) {
                    // Mostra conta destino, esconde categoria
                    if (categorySelect) categorySelect.style.display = 'none';
                    if (destinationAccountSelect) destinationAccountSelect.style.display = 'block';
                    // Para transferências, sempre é débito na conta principal
                    if (transactionTypeSelect) {
                        transactionTypeSelect.value = 'DB';
                        transactionTypeSelect.style.backgroundColor = '#e9ecef';
                        transactionTypeSelect.style.cursor = 'not-allowed';
                        transactionTypeSelect.disabled = true;
                        // Cria input hidden para garantir que o valor seja enviado (campos disabled não são enviados)
                        const hiddenName = transactionTypeSelect.name;
                        let hiddenInput = lineElement.querySelector(`input[name="${hiddenName}"]`);
                        if (!hiddenInput) {
                            hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = hiddenName;
                            hiddenInput.value = 'DB';
                            lineElement.appendChild(hiddenInput);
                        } else {
                            hiddenInput.value = 'DB';
                        }
                    }
                } else {
                    // Mostra categoria, esconde conta destino
                    if (categorySelect) categorySelect.style.display = 'block';
                    if (destinationAccountSelect) destinationAccountSelect.style.display = 'none';
                    // Para transações normais, permite escolher o tipo
                    if (transactionTypeSelect) {
                        transactionTypeSelect.style.backgroundColor = '';
                        transactionTypeSelect.style.cursor = '';
                        transactionTypeSelect.disabled = false;
                        // Remove o input hidden se existir
                        const hiddenName = transactionTypeSelect.name;
                        const hiddenInput = lineElement.querySelector(`input[name="${hiddenName}"]`);
                        if (hiddenInput && hiddenInput.type === 'hidden') {
                            hiddenInput.remove();
                        }
                    }
                }
                calculateNetBalance();
            }
        }
        
        function addLine(lineData = null) {
            const tbody = document.getElementById('lines-tbody');
            const lineIndex = lineCounter++;
            
            const lineRow = document.createElement('tr');
            lineRow.className = 'transaction-line';
            lineRow.innerHTML = `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <input type="checkbox" name="line_${lineIndex}_is_transfer" class="transfer-checkbox" 
                           ${lineData && lineData.line_type === 'transfer' ? 'checked' : ''}>
                </td>
                <td class="category-cell" style="padding: 8px; border: 1px solid #ddd;">
                    <div>
                        <select name="line_${lineIndex}_category" class="form-control category-select">
                            <option value="">Selecione</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" data-default-type="{{ category.default_transaction_type }}">{{ category.category }} - {{ category.subcategory }}</option>
                            {% endfor %}
                        </select>
                        <select name="line_${lineIndex}_destination_account" class="form-control destination-account-select" style="display: none;">
                            <option value="">Selecione</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">{{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <select name="line_${lineIndex}_transaction_type" class="form-control transaction-type-select" required>
                        <option value="">Selecione</option>
                        <option value="CR" ${lineData && lineData.transaction_type === 'CR' ? 'selected' : ''}>Crédito</option>
                        <option value="DB" ${lineData && lineData.transaction_type === 'DB' ? 'selected' : ''}>Débito</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="number" name="line_${lineIndex}_value" step="0.01" min="0.01" 
                           class="form-control" style="width: 120px;" required value="${lineData ? lineData.value : ''}">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" name="line_${lineIndex}_description" 
                           class="form-control" placeholder="Descrição (opcional)" maxlength="500" style="width: 200px;" value="${lineData ? (lineData.description || '') : ''}">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <button type="button" class="remove-line-btn" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Remover
                    </button>
                </td>
            `;
            
            // Adiciona event listeners
            const valueInput = lineRow.querySelector('input[name*="_value"]');
            const typeSelect = lineRow.querySelector('select[name*="_transaction_type"]');
            const transferCheckbox = lineRow.querySelector('input[name*="_is_transfer"]');
            const categorySelect = lineRow.querySelector('select[name*="_category"]');
            const removeBtn = lineRow.querySelector('.remove-line-btn');
            
            valueInput.addEventListener('input', calculateNetBalance);
            typeSelect.addEventListener('change', calculateNetBalance);
            transferCheckbox.addEventListener('change', function() {
                toggleLineFields(lineRow);
            });
            
            // Preenche tipo automaticamente quando categoria é selecionada
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    if (!transferCheckbox.checked && this.value) {
                        const selectedOption = this.options[this.selectedIndex];
                        const defaultType = selectedOption.getAttribute('data-default-type');
                        if (defaultType && typeSelect) {
                            typeSelect.value = defaultType;
                            calculateNetBalance();
                        }
                    }
                });
            }
            removeBtn.addEventListener('click', function() {
                lineRow.remove();
                calculateNetBalance();
            });
            
            tbody.appendChild(lineRow);
            
            // Se tiver dados, preenche os valores e aplica toggle
            if (lineData) {
                // Preenche categoria se houver
                if (lineData.category_id) {
                    const categorySelect = lineRow.querySelector('select[name*="_category"]');
                    if (categorySelect) {
                        categorySelect.value = lineData.category_id;
                    }
                }
                
                // Preenche conta de destino se houver
                if (lineData.destination_account_id) {
                    const destAccountSelect = lineRow.querySelector('select[name*="_destination_account"]');
                    if (destAccountSelect) {
                        destAccountSelect.value = lineData.destination_account_id;
                    }
                }
                
                // Aplica toggle para mostrar/esconder campos corretos baseado no checkbox
                toggleLineFields(lineRow);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('add-line-btn');
            const accountSelect = document.getElementById('id_account');
            
            addBtn.addEventListener('click', function() {
                addLine();
            });
            
            // Se estiver em modo edição, preenche as linhas existentes
            {% if is_edit and existing_lines_json %}
            try {
                // existing_lines_json já é uma string JSON do Python, precisa ser parseado
                const existingLinesJsonString = '{{ existing_lines_json|escapejs }}';
                const existingLines = JSON.parse(existingLinesJsonString);
                console.log('Linhas carregadas:', existingLines);
                if (Array.isArray(existingLines) && existingLines.length > 0) {
                    existingLines.forEach(function(lineData) {
                        addLine(lineData);
                    });
                } else {
                    console.warn('Nenhuma linha encontrada ou array vazio');
                    addLine();
                }
            } catch (e) {
                console.error('Erro ao carregar linhas existentes:', e, 'JSON:', '{{ existing_lines_json|escapejs }}');
                addLine();
            }
            {% else %}
            // Adiciona uma linha inicial apenas se não estiver editando
            addLine();
            {% endif %}
            
            // Calcula saldo inicial
            calculateNetBalance();
        });
    </script>
{% endblock %}
